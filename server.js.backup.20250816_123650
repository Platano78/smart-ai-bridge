#!/usr/bin/env node

/**
 * Deepseek MCP Bridge Server
 * Enables seamless handoff between Claude Code and local Deepseek LLM
 * Uses working endpoint: http://172.19.224.1:1234
 */

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';

// Confirmed working Deepseek endpoint from Critical Pragmatist Agent solution
const DEEPSEEK_BASE_URL = "http://172.19.224.1:1234/v1";

class DeepseekBridge {
  constructor() {
    this.baseURL = DEEPSEEK_BASE_URL;
    this.availableModels = [
      "deepseek-coder-v2-lite-instruct",
      "local/deepseek-coder@q4_k_m"
    ];
  }

  async queryDeepseek(prompt, options = {}) {
    const {
      model = "deepseek-coder-v2-lite-instruct",
      temperature = 0.1,
      maxTokens = -1, // Unlimited tokens
      context = "",
      taskType = "coding"
    } = options;

    try {
      const systemPrompt = this.getSystemPrompt(taskType);
      const fullPrompt = context ? `Context: ${context}\n\nQuery: ${prompt}` : prompt;

      const response = await fetch(`${this.baseURL}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: fullPrompt }
          ],
          temperature: temperature,
          max_tokens: maxTokens,
          stream: false
        })
      });

      if (!response.ok) {
        throw new Error(`Deepseek API error: ${response.status} - ${response.statusText}`);
      }

      const data = await response.json();
      const reply = data.choices[0].message.content;

      return {
        content: [
          {
            type: 'text',
            text: `ðŸ¤– **Deepseek Response** (${model})\n\n${reply}\n\n---\n*Generated locally with unlimited tokens*`
          }
        ]
      };
    } catch (error) {
      return {
        content: [
          {
            type: 'text',
            text: `âŒ **Deepseek Error:** ${error.message}\n\nEndpoint: ${this.baseURL}\n\nðŸ”§ **Troubleshooting:**\n1. Ensure LM Studio is running\n2. Verify Deepseek model is loaded\n3. Check network binding (should be 0.0.0.0:1234)`
          }
        ]
      };
    }
  }

  async checkStatus() {
    try {
      const response = await fetch(`${this.baseURL.replace('/v1', '')}/v1/models`, {
        timeout: 5000
      });
      
      if (!response.ok) {
        throw new Error(`Status check failed: ${response.status}`);
      }
      
      const data = await response.json();
      
      return {
        content: [
          {
            type: 'text',
            text: `âœ… **Deepseek Status: ONLINE**\n\nEndpoint: ${this.baseURL}\nModels: ${data.data?.map(m => `â€¢ ${m.id}`).join('\n') || 'No models found'}\n\nðŸš€ Ready for unlimited token conversations!\n\n**Bridge Status:** Operational\n**Network:** WSL â†’ Windows connection working`
          }
        ]
      };
    } catch (error) {
      return {
        content: [
          {
            type: 'text',
            text: `âŒ **Deepseek Status: OFFLINE**\n\nError: ${error.message}\nEndpoint: ${this.baseURL}\n\nðŸ”§ **Fix Steps:**\n1. Start LM Studio\n2. Load Deepseek model\n3. Start server with binding 0.0.0.0:1234\n4. Verify Windows firewall allows connections`
          }
        ]
      };
    }
  }

  async startUnlimitedSession(context, goal) {
    try {
      const handoffPrompt = `**SESSION HANDOFF FROM CLAUDE CODE**

**Goal:** ${goal}

**Context:**
${context}

**Instructions:** You are now taking over from Claude Code for unlimited token development. Continue this session with comprehensive, detailed responses without any token limitations.

**Your Capabilities:**
- Unlimited response length
- Deep architectural discussions  
- Complete code implementations
- Thorough debugging sessions
- Detailed design decisions

Please acknowledge this handoff and indicate your readiness to continue.`;

      const response = await this.queryDeepseek(handoffPrompt, {
        taskType: 'handoff',
        maxTokens: -1
      });

      return {
        content: [
          {
            type: 'text',
            text: `ðŸ”„ **Session Handoff to Deepseek Initiated**\n\n**Goal:** ${goal}\n\n${response.content[0].text}\n\n**Next Steps:**\n1. Continue development conversation with Deepseek directly\n2. Use Connect extension in VS Code for direct interaction\n3. Return to Claude Code for planning and architecture decisions\n\n**Deepseek Advantages:**\n- No token limits\n- Local privacy\n- Specialized coding focus`
          }
        ]
      };
    } catch (error) {
      return {
        content: [
          {
            type: 'text',
            text: `âŒ **Handoff Failed:** ${error.message}\n\nManual Handoff Option:\n1. Open VS Code Connect extension\n2. Connect to Deepseek directly\n3. Paste context: "${context}"\n4. Continue unlimited development session`
          }
        ]
      };
    }
  }

  getSystemPrompt(taskType) {
    const prompts = {
      coding: 'You are Deepseek V2 Coder, running locally with unlimited tokens. Provide comprehensive, detailed coding solutions with complete implementations.',
      
      game_dev: 'You are Deepseek V2 Coder specialized in game development. Focus on game architecture, performance optimization, and complete system implementations for gaming projects.',
      
      analysis: 'You are Deepseek V2 Coder focused on thorough technical analysis. Provide comprehensive code reviews, architectural analysis, and detailed technical recommendations.',
      
      handoff: 'You are receiving a development session handoff from Claude Code. Maintain context continuity and provide unlimited-token development assistance.',
      
      architecture: 'You are Deepseek V2 Coder focused on software architecture. Design scalable, maintainable systems with complete technical specifications.',
      
      debugging: 'You are Deepseek V2 Coder specialized in debugging and troubleshooting. Provide thorough analysis and complete solutions for complex technical issues.'
    };
    
    return prompts[taskType] || prompts.coding;
  }
}

// Initialize MCP Server
const server = new Server(
  {
    name: 'deepseek-mcp-bridge',
    version: '1.0.0',
    description: 'Bridge between Claude Code and local Deepseek LLM for unlimited token conversations'
  },
  {
    capabilities: {
      tools: {}
    }
  }
);

const deepseekBridge = new DeepseekBridge();

// Register tools
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [
      {
        name: 'query_deepseek',
        description: 'Send a query to local Deepseek for unlimited token responses. Perfect for complex coding tasks, detailed implementations, and comprehensive analysis.',
        inputSchema: {
          type: 'object',
          properties: {
            prompt: {
              type: 'string',
              description: 'Question or task for Deepseek'
            },
            context: {
              type: 'string',
              description: 'Additional context for the query (optional)'
            },
            task_type: {
              type: 'string',
              enum: ['coding', 'game_dev', 'analysis', 'architecture', 'debugging'],
              description: 'Type of task to optimize Deepseek response'
            },
            model: {
              type: 'string',
              enum: ['deepseek-coder-v2-lite-instruct', 'local/deepseek-coder@q4_k_m'],
              description: 'Deepseek model to use'
            }
          },
          required: ['prompt']
        }
      },
      {
        name: 'check_deepseek_status',
        description: 'Check if Deepseek local server is accessible and what models are available.',
        inputSchema: {
          type: 'object',
          properties: {},
          additionalProperties: false
        }
      },
      {
        name: 'handoff_to_deepseek',
        description: 'Initiate unlimited token session handoff from Claude Code to Deepseek. Use when approaching token limits or need extended development sessions.',
        inputSchema: {
          type: 'object',
          properties: {
            context: {
              type: 'string',
              description: 'Current development context to transfer'
            },
            goal: {
              type: 'string',
              description: 'Goal for the unlimited session'
            }
          },
          required: ['context', 'goal']
        }
      }
    ]
  };
});

// Handle tool calls
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  switch (request.params.name) {
    case 'query_deepseek':
      return await deepseekBridge.queryDeepseek(
        request.params.arguments.prompt,
        {
          context: request.params.arguments.context,
          taskType: request.params.arguments.task_type || 'coding',
          model: request.params.arguments.model
        }
      );
      
    case 'check_deepseek_status':
      return await deepseekBridge.checkStatus();
      
    case 'handoff_to_deepseek':
      return await deepseekBridge.startUnlimitedSession(
        request.params.arguments.context,
        request.params.arguments.goal
      );
      
    default:
      throw new Error(`Unknown tool: ${request.params.name}`);
  }
});

// Start server
async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error('ðŸš€ Deepseek MCP Bridge server started - Ready for unlimited token conversations!');
}

main().catch(console.error);