#!/usr/bin/env node

/**
 * MKG v9.1 Perception Engine Tests
 */

const path = require('path');
const toolsConfig = require('../src/config/tools-config.json');
const { PerceptionEngine } = require('../src/perception');

async function testPerception() {
  console.log('\nðŸ” MKG v9.1 Perception Engine Tests\n');
  console.log('='.repeat(70));

  const perception = new PerceptionEngine(toolsConfig);
  const workingDir = process.cwd();

  console.log(`\nðŸ“ Testing perception on: ${workingDir}\n`);

  // Test 1: Basic perception
  console.log('Test 1: Basic Perception');
  try {
    const result = await perception.perceive(workingDir);
    console.log(`   âœ… Language detected: ${result.language.primary} (confidence: ${(result.language.confidence * 100).toFixed(1)}%)`);
    console.log(`   âœ… Files found: ${result.existingFiles.length}`);
    console.log(`   âœ… Entry points: ${result.entryPoints.slice(0, 3).join(', ')}`);
    console.log(`   âœ… Test locations: ${result.testLocations.join(', ') || 'none'}`);
    console.log(`   âœ… Summary: ${result.summary}`);
    console.log(`   âœ… Latency: ${result.latency_ms}ms`);
  } catch (error) {
    console.log(`   âŒ Error: ${error.message}`);
  }

  // Test 2: Caching
  console.log('\nTest 2: Cache Functionality');
  try {
    const result1 = await perception.perceive(workingDir);
    const result2 = await perception.perceive(workingDir);
    
    if (result2.cached) {
      console.log(`   âœ… Cache hit on second call`);
      console.log(`   âœ… Cache stats: ${JSON.stringify(perception.getCacheStats())}`);
    } else {
      console.log(`   âš ï¸  Cache miss (TTL may have expired)`);
    }
  } catch (error) {
    console.log(`   âŒ Error: ${error.message}`);
  }

  // Test 3: Trigger conditions
  console.log('\nTest 3: Trigger Conditions');
  const testContexts = [
    { complexity: 'high', expected: true },
    { complexity: 'low', expected: false },
    { fileCount: 5, expected: true },
    { fileCount: 1, expected: false },
    { taskType: 'refactoring', expected: true },
    { taskType: 'coding', expected: false }
  ];

  for (const ctx of testContexts) {
    const shouldTrigger = perception.shouldPerceive(ctx);
    const status = shouldTrigger === ctx.expected ? 'âœ…' : 'âŒ';
    console.log(`   ${status} Context ${JSON.stringify(ctx)}: ${shouldTrigger ? 'TRIGGERS' : 'does not trigger'}`);
  }

  console.log('\n' + '='.repeat(70));
  console.log('\nPerception tests complete!');
}

testPerception().catch(error => {
  console.error('Perception tests failed:', error);
  process.exit(1);
});
